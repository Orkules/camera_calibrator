<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luminar Camera Calibration</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f0f0f0;
        }
        
        .container {
            display: flex;
            gap: 10px;
            height: calc(100vh - 20px);
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* Sidebar sections (left and right) */
        .sidebar {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        
        /* Center section (stream + console) */
        .center-section {
            flex: 2;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toolbar-box {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #f9f9f9;
        }
        
        .toolbar-box h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            text-align: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 5px 0;
        }
        
        .value-display {
            min-width: 50px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            padding: 5px 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            min-width: 40px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-arrow {
            padding: 5px 10px;
            font-size: 18px;
        }
        
        .btn-smart {
            width: 100%;
            margin-top: 5px;
            background: #28a745;
        }
        
        .btn-smart:hover {
            background: #218838;
        }
        
        .btn-mode {
            width: 100%;
            margin-top: 5px;
            background: #6c757d;
        }
        
        .btn-mode:hover {
            background: #5a6268;
        }
        
        .btn-tab {
            background: #6c757d;
            border: 2px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
        }
        
        .btn-tab:hover {
            background: #5a6268;
        }
        
        .btn-tab.active {
            background: #007bff;
            border-color: #007bff;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn:disabled:hover {
            background: #6c757d;
        }
        
        .btn-toggle {
            width: auto;
            min-width: 100px;
            margin-top: 5px;
            padding: 8px 10px;
            background: #6c757d;
            font-size: 11px;
            line-height: 1.3;
            height: auto;
            white-space: normal;
        }
        
        .btn-toggle.active {
            background: #28a745;
        }
        
        .btn-toggle.active:hover {
            background: #218838;
        }
        
        .focus-main-row {
            display: flex;
            gap: 10px;
            align-items: stretch;
            margin-bottom: 10px;
        }
        
        .focus-control-vertical {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
            justify-content: center;
            min-width: 80px;
        }
        
        .focus-control-vertical .value-display {
            min-width: 70px;
            font-size: 16px;
            padding: 8px 12px;
        }
        
        .focus-info-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 2;
            min-width: 0;
        }
        
        .focus-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .focus-info-item label {
            font-size: 12px;
            font-weight: bold;
            min-width: 90px;
        }
        
        .focus-info-item .value-display {
            min-width: 100px;
            font-size: 14px;
            padding: 3px 8px;
            flex: 1;
        }
        
        .focus-ok-button {
            width: 100%;
            padding: 8px 15px;
            margin-top: 5px;
            align-self: flex-start;
        }
        
        .focus-auto-button-wrapper {
            display: flex;
            align-items: stretch;
            flex-shrink: 0;
            min-width: 90px;
        }
        
        .focus-auto-button-wrapper .btn-toggle {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-width: 90px;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        /* Stream frame */
        .stream-frame {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            min-height: 400px;
            overflow: hidden;
        }
        
        .stream-frame img {
            width: 100%;
            height: 100%;
            object-fit: fill;
        }
        
        /* Console section */
        .console-box {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
            max-height: 300px;
        }
        
        .console-text {
            flex: 1;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .console-input-row {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            align-items: center;
        }
        
        .terminal-select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
            background: white;
            cursor: pointer;
            min-width: 100px;
        }
        
        .command-input {
            flex: 1;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .command-input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        /* Main controls */
        .main-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .main-controls .btn {
            flex: 1;
        }
        
        .status {
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 12px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Input fields */
        .input-field {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .input-label {
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
            display: block;
        }
        
        /* Gain section specific */
        .gain-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 5px;
        }
        
        .gain-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .gain-info-row label {
            font-size: 12px;
            font-weight: bold;
        }
        
        .gain-info-row .value-display {
            min-width: 80px;
            font-size: 14px;
        }
        
        .time-interval-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        
        /* Info display box */
        .info-box {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #f9f9f9;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
        }
        
        .info-row label {
            font-size: 12px;
            font-weight: bold;
        }
        
        .info-row .value-display {
            min-width: 80px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <!-- Camera Info Box -->
            <div class="info-box">
                <h3>Camera Information</h3>
                <div class="info-row" style="align-items: center; gap: 5px;">
                    <label style="margin: 0;">Motor Max:</label>
                    <div class="value-display" id="motor-max-value" style="flex: 1; margin: 0;">0</div>
                    <button class="btn" onclick="calculateMotorMax()" style="padding: 5px 15px; margin: 0;">Calculate</button>
                </div>
                <div class="info-row">
                    <label>Distance to Target:</label>
                    <input type="number" class="input-field" id="distance-to-target" min="1" max="100" value="1" style="width: 80px; margin: 0;" onchange="setDistanceToTarget()">
                </div>
                <div class="info-row" style="align-items: center; gap: 5px;">
                    <label class="input-label" style="margin: 0; min-width: 140px;">Camera Serial Number:</label>
                    <input type="text" class="input-field" id="camera-serial" placeholder="Enter serial number" style="flex: 1; margin: 0;">
                    <button class="btn" onclick="setCameraSerial()" style="padding: 5px 15px; margin: 0;">Set</button>
                </div>
                <div class="info-row" style="align-items: center; gap: 5px;">
                    <label class="input-label" style="margin: 0; min-width: 140px;">Technician Name:</label>
                    <input type="text" class="input-field" id="technician-name" placeholder="Enter technician name" style="flex: 1; margin: 0;">
                    <button class="btn" onclick="setTechnicianName()" style="padding: 5px 15px; margin: 0;">Set</button>
                </div>
            </div>
            
            <!-- Focus Calibration -->
            <div class="toolbar-box">
                <h3>Focus Calibration</h3>
                <div class="focus-main-row">
                    <!-- Left: Vertical arrows and value -->
                    <div class="focus-control-vertical">
                        <button class="btn btn-arrow" id="focus-increase-btn"
                                onmousedown="startLongPress('focus', 1)" 
                                onmouseup="stopLongPress('focus')"
                                onmouseleave="stopLongPress('focus')"
                                ontouchstart="startLongPress('focus', 1)"
                                ontouchend="stopLongPress('focus')">▲</button>
                        <div class="value-display" id="focus-value">0</div>
                        <button class="btn btn-arrow" id="focus-decrease-btn"
                                onmousedown="startLongPress('focus', -1)" 
                                onmouseup="stopLongPress('focus')"
                                onmouseleave="stopLongPress('focus')"
                                ontouchstart="startLongPress('focus', -1)"
                                ontouchend="stopLongPress('focus')">▼</button>
                    </div>
                    
                    <!-- Middle: Auto Focus button (tall, same height as right section) -->
                    <div class="focus-auto-button-wrapper">
                        <button class="btn btn-toggle" id="auto-focus-btn" onclick="toggleAutoFocus()">
                            <div>Auto</div>
                            <div>Focus</div>
                            <div id="auto-focus-status">OFF</div>
                        </button>
                    </div>
                    
                    <!-- Right: Info windows and OK button -->
                    <div class="focus-info-section">
                        <div class="focus-info-item">
                            <label>VIS Position:</label>
                            <div class="value-display" id="vis-position-value">0</div>
                        </div>
                        <div class="focus-info-item">
                            <label>UV Position:</label>
                            <div class="value-display" id="uv-position-value">0</div>
                        </div>
                        <div class="focus-info-item">
                            <label>Zoom Status:</label>
                            <div class="value-display" id="zoom-status-value">-</div>
                        </div>
                        <div class="focus-info-item">
                            <label>Distance:</label>
                            <div class="value-display" id="distance-value">0</div>
                        </div>
                        <button class="btn focus-ok-button" onclick="focusOk()">OK</button>
                    </div>
                </div>
                <button class="btn btn-smart" onclick="smartFocus()">Smart Calibration</button>
            </div>
            
            <!-- Gain Calibration -->
            <div class="toolbar-box">
                <h3>Gain Calibration</h3>
                <div class="control-row">
                    <button class="btn btn-arrow" 
                            onmousedown="startLongPress('gain', -1, 0, 255)" 
                            onmouseup="stopLongPress('gain')"
                            onmouseleave="stopLongPress('gain')"
                            ontouchstart="startLongPress('gain', -1, 0, 255)"
                            ontouchend="stopLongPress('gain')">◄</button>
                    <div class="value-display" id="gain-value">0</div>
                    <button class="btn btn-arrow" 
                            onmousedown="startLongPress('gain', 1, 0, 255)" 
                            onmouseup="stopLongPress('gain')"
                            onmouseleave="stopLongPress('gain')"
                            ontouchstart="startLongPress('gain', 1, 0, 255)"
                            ontouchend="stopLongPress('gain')">►</button>
                    <button class="btn" onclick="startGainCounting()" style="padding: 5px 10px; font-size: 12px; margin-left: 5px;">Start Counting</button>
                </div>
                <!-- Set Min/Medium/Max buttons -->
                <div style="display: flex; gap: 5px; margin: 5px 0;">
                    <button class="btn btn-mode" onclick="setGainMin()" style="flex: 1; font-size: 12px;">Set Min</button>
                    <button class="btn btn-mode" onclick="setGainMedium()" style="flex: 1; font-size: 12px;">Set Medium</button>
                    <button class="btn btn-mode" onclick="setGainMax()" style="flex: 1; font-size: 12px;">Set Max</button>
                </div>
                <!-- Min/Medium/Max value displays -->
                <div style="display: flex; gap: 5px; margin: 5px 0;">
                    <div class="value-display" id="gain-min-value" style="flex: 1; font-size: 14px;">0</div>
                    <div class="value-display" id="gain-medium-value" style="flex: 1; font-size: 14px;">0</div>
                    <div class="value-display" id="gain-max-value" style="flex: 1; font-size: 14px;">0</div>
                </div>
                <!-- Clear and OK buttons -->
                <div style="display: flex; gap: 5px; margin: 5px 0;">
                    <button class="btn" onclick="clearGainValues()" style="flex: 1; font-size: 12px;">Clear</button>
                    <button class="btn" onclick="gainOk()" style="flex: 1; font-size: 12px;">OK</button>
                </div>
                <!-- CPS and Time Interval in same row -->
                <div style="display: flex; gap: 5px; margin: 5px 0; align-items: center;">
                    <label style="font-size: 12px; font-weight: bold; min-width: 60px;">CPS:</label>
                    <div class="value-display" id="cps-value" style="flex: 1; font-size: 14px;">0</div>
                    <label style="font-size: 12px; font-weight: bold; min-width: 80px; margin-left: 10px;">Time Interval:</label>
                    <input type="text" class="time-interval-input" id="time-interval" placeholder="Enter value" style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px;">
                </div>
                <button class="btn" onclick="setTimeInterval()" style="margin-top: 5px; width: 100%;">Set Interval</button>
                <button class="btn btn-smart" onclick="smartGain()" style="margin-top: 5px;">Smart Calibration</button>
            </div>
        </div>
        
        <!-- Center Section (Stream + Console) -->
        <div class="center-section">
            <div class="main-controls">
                <button class="btn" onclick="startStream()">Start Stream</button>
                <button class="btn btn-danger" onclick="stopStream()">Stop Stream</button>
                <button class="btn" onclick="connectTerminals()">Connect Terminals</button>
            </div>
            <div class="status" id="status"></div>
            <div class="stream-frame" id="stream-frame">
                <span>No stream active</span>
            </div>
            <div class="toolbar-box console-box">
                <h3>Console</h3>
                <div class="console-text" id="console-text">Waiting for connection...\n</div>
                <div class="console-input-row">
                    <select class="terminal-select" id="terminal-select">
                        <option value="Debug">Debug</option>
                        <option value="FPGA">FPGA</option>
                        <option value="Linux">Linux</option>
                    </select>
                    <input type="text" class="command-input" id="command-input" placeholder="Enter command..." onkeypress="handleCommandKeyPress(event)">
                    <button class="btn" onclick="sendTerminalCommand()" style="padding: 5px 15px; font-size: 12px;">Send</button>
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar -->
        <div class="sidebar">
            <!-- Zoom Station -->
            <div class="toolbar-box">
                <h3>Zoom Station</h3>
                <div class="control-row">
                    <button class="btn btn-arrow" 
                            onmousedown="startLongPress('zoom', -1, 0, 26)" 
                            onmouseup="stopLongPress('zoom')"
                            onmouseleave="stopLongPress('zoom')"
                            ontouchstart="startLongPress('zoom', -1, 0, 26)"
                            ontouchend="stopLongPress('zoom')">◄</button>
                    <div class="value-display" id="zoom-value">0</div>
                    <button class="btn btn-arrow" 
                            onmousedown="startLongPress('zoom', 1, 0, 26)" 
                            onmouseup="stopLongPress('zoom')"
                            onmouseleave="stopLongPress('zoom')"
                            ontouchstart="startLongPress('zoom', 1, 0, 26)"
                            ontouchend="stopLongPress('zoom')">►</button>
                </div>
            </div>
            
            <!-- Registration -->
            <div class="toolbar-box">
                <h3>Registration</h3>
                <!-- Master Registration Mode Tabs -->
                <div style="display: flex; gap: 3px; margin-bottom: 8px;">
                    <button class="btn btn-tab" id="reg-master-per-zoom" onclick="setMasterRegistrationMode('per_zoom')" style="flex: 1; padding: 4px 6px; font-size: 11px;">Per Zoom</button>
                    <button class="btn btn-tab" id="reg-master-wide" onclick="setMasterRegistrationMode('wide')" style="flex: 1; padding: 4px 6px; font-size: 11px;">Wide</button>
                    <button class="btn btn-tab" id="reg-master-narrow" onclick="setMasterRegistrationMode('narrow')" style="flex: 1; padding: 4px 6px; font-size: 11px;">Narrow</button>
                </div>
                <!-- Shift / Stretch-Compress Mode -->
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <button class="btn btn-mode" id="reg-mode-shift" onclick="setRegistrationMode('shift')" style="flex: 1;">Shift</button>
                    <button class="btn btn-mode" id="reg-mode-stretch" onclick="setRegistrationMode('stretch_compress')" style="flex: 1;">Stretch/Compress</button>
                </div>
                <div style="display: grid; grid-template-columns: auto 10px auto 10px auto 10px auto 10px auto; gap: 0; max-width: 280px; margin: 0 auto; align-items: center; justify-items: center;">
                    <!-- Row 1: X values and Up arrow -->
                    <div class="value-display" id="reg-shift-x" style="font-size: 14px; min-width: 55px; padding: 5px 8px; grid-column: 1; grid-row: 1;">X:0</div>
                    <div style="grid-column: 2; grid-row: 1;"></div>
                    <div style="grid-column: 3; grid-row: 1;"></div>
                    <div style="grid-column: 4; grid-row: 1;"></div>
                    <button class="btn btn-arrow" 
                            onmousedown="startLongPress('reg', 'up')" 
                            onmouseup="stopLongPress('reg')"
                            onmouseleave="stopLongPress('reg')"
                            ontouchstart="startLongPress('reg', 'up')"
                            ontouchend="stopLongPress('reg')"
                            style="grid-column: 5; grid-row: 1;">▲</button>
                    <div style="grid-column: 6; grid-row: 1;"></div>
                    <div style="grid-column: 7; grid-row: 1;"></div>
                    <div style="grid-column: 8; grid-row: 1;"></div>
                    <div class="value-display" id="reg-stretch-x" style="font-size: 14px; min-width: 55px; padding: 5px 8px; grid-column: 9; grid-row: 1;">X:0</div>
                    
                    <!-- Row 2: Y values and Left/OK/Right arrows -->
                    <div class="value-display" id="reg-shift-y" style="font-size: 14px; min-width: 55px; padding: 5px 8px; grid-column: 1; grid-row: 2;">Y:0</div>
                    <div style="grid-column: 2; grid-row: 2;"></div>
                    <button class="btn btn-arrow" 
                            onmousedown="startLongPress('reg', 'left')" 
                            onmouseup="stopLongPress('reg')"
                            onmouseleave="stopLongPress('reg')"
                            ontouchstart="startLongPress('reg', 'left')"
                            ontouchend="stopLongPress('reg')"
                            style="grid-column: 3; grid-row: 2;">◄</button>
                    <div style="grid-column: 4; grid-row: 2;"></div>
                    <button class="btn" onclick="regOk()" style="grid-column: 5; grid-row: 2; padding: 5px 10px; font-size: 12px;">OK</button>
                    <div style="grid-column: 6; grid-row: 2;"></div>
                    <button class="btn btn-arrow" 
                            onmousedown="startLongPress('reg', 'right')" 
                            onmouseup="stopLongPress('reg')"
                            onmouseleave="stopLongPress('reg')"
                            ontouchstart="startLongPress('reg', 'right')"
                            ontouchend="stopLongPress('reg')"
                            style="grid-column: 7; grid-row: 2;">►</button>
                    <div style="grid-column: 8; grid-row: 2;"></div>
                    <div class="value-display" id="reg-stretch-y" style="font-size: 14px; min-width: 55px; padding: 5px 8px; grid-column: 9; grid-row: 2;">Y:0</div>
                    
                    <!-- Row 3: Down arrow -->
                    <div style="grid-column: 1; grid-row: 3;"></div>
                    <div style="grid-column: 2; grid-row: 3;"></div>
                    <div style="grid-column: 3; grid-row: 3;"></div>
                    <div style="grid-column: 4; grid-row: 3;"></div>
                    <button class="btn btn-arrow" 
                            onmousedown="startLongPress('reg', 'down')" 
                            onmouseup="stopLongPress('reg')"
                            onmouseleave="stopLongPress('reg')"
                            ontouchstart="startLongPress('reg', 'down')"
                            ontouchend="stopLongPress('reg')"
                            style="grid-column: 5; grid-row: 3;">▼</button>
                    <div style="grid-column: 6; grid-row: 3;"></div>
                    <div style="grid-column: 7; grid-row: 3;"></div>
                    <div style="grid-column: 8; grid-row: 3;"></div>
                    <div style="grid-column: 9; grid-row: 3;"></div>
                </div>
                <button class="btn btn-smart" onclick="smartRegistration()">Smart Calibration</button>
            </div>
            
            <!-- Camera Control -->
            <div class="toolbar-box">
                <h3>Camera Control</h3>
                <div style="display: flex; gap: 5px; justify-content: center;">
                    <button class="btn btn-mode" id="camera-mode-vis" onclick="setCameraMode(1)" style="flex: 1; padding: 6px 10px; font-size: 12px;">VIS ONLY</button>
                    <button class="btn btn-mode" id="camera-mode-uv" onclick="setCameraMode(2)" style="flex: 1; padding: 6px 10px; font-size: 12px;">UV ONLY</button>
                    <button class="btn btn-mode" id="camera-mode-combined" onclick="setCameraMode(3)" style="flex: 1; padding: 6px 10px; font-size: 12px;">UV & VIS</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let streamInterval = null;
        let updateInterval = null;
        let consoleInterval = null;
        
        // Long-press functionality
        let longPressInterval = null;
        let longPressTimeout = null;  // Timeout before fast mode starts
        let longPressType = null;
        let longPressDirection = null;
        let longPressCurrentValue = null;
        let longPressOriginalValue = null;
        let longPressMin = null;
        let longPressMax = null;
        let longPressSpeed = 30;   // 30ms = faster updates
        let longPressDelay = 400;  // 400ms delay before fast mode
        
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }
        
        function logToConsole(message) {
            // This function is kept for local messages, but console is now updated from server
        }
        
        async function updateConsole() {
            try {
                const response = await fetch('/get_console');
                const data = await response.json();
                
                if (data.messages) {
                    const consoleElement = document.getElementById('console-text');
                    consoleElement.textContent = data.messages;
                    consoleElement.scrollTop = consoleElement.scrollHeight;
                }
            } catch (error) {
                console.error('Error fetching console messages:', error);
            }
        }
        
        // ============================================
        // STREAM CONTROL FUNCTIONS
        // ============================================
        async function startStream() {
            try {
                const response = await fetch('/start_stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rtsp_url: 'rtsp://192.168.0.100:9079/vis'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('Stream started successfully!', 'success');
                    logToConsole('Stream started');
                    startFrameUpdates();
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                    logToConsole(`Stream error: ${result.error}`);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                logToConsole(`Stream error: ${error.message}`);
            }
        }
        
        async function stopStream() {
            try {
                const response = await fetch('/stop_stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('Stream stopped', 'info');
                    logToConsole('Stream stopped');
                    stopFrameUpdates();
                    document.getElementById('stream-frame').innerHTML = '<span>No stream active</span>';
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                logToConsole(`Error: ${error.message}`);
            }
        }
        
        async function connectTerminals() {
            try {
                const response = await fetch('/connect_terminals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('Terminals connected', 'success');
                    logToConsole('Terminals connected successfully');
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                    logToConsole(`Terminal connection error: ${result.error}`);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                logToConsole(`Error: ${error.message}`);
            }
        }
        
        function startFrameUpdates() {
            if (streamInterval) {
                clearInterval(streamInterval);
            }
            
            streamInterval = setInterval(async () => {
                try {
                    const response = await fetch('/get_frame');
                    const data = await response.json();
                    
                    if (data.frame) {
                        document.getElementById('stream-frame').innerHTML = 
                            `<img src="${data.frame}" style="width: 100%; height: 100%; object-fit: fill;">`;
                    }
                } catch (error) {
                    console.error('Error fetching frame:', error);
                }
            }, 100);
        }
        
        function stopFrameUpdates() {
            if (streamInterval) {
                clearInterval(streamInterval);
                streamInterval = null;
            }
        }
        
        // ============================================
        // CAMERA INFO FUNCTIONS
        // ============================================
        async function setCameraSerial() {
            const serial = document.getElementById('camera-serial').value;
            try {
                const response = await fetch('/set_camera_serial', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ camera_serial: serial })
                });
                const result = await response.json();
                if (result.success) {
                    showStatus(result.message || 'Camera serial number saved', 'success');
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function setTechnicianName() {
            const name = document.getElementById('technician-name').value;
            try {
                const response = await fetch('/set_technician_name', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ technician_name: name })
                });
                const result = await response.json();
                if (result.success) {
                    showStatus(result.message || 'Technician name saved', 'success');
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function setDistanceToTarget() {
            const distanceInput = document.getElementById('distance-to-target');
            const distanceValue = parseInt(distanceInput.value);
            
            if (isNaN(distanceValue) || distanceValue < 1 || distanceValue > 100) {
                showStatus('Error: Distance must be between 1 and 100', 'error');
                return;
            }
            
            try {
                const response = await fetch('/set_distance_to_target', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ distance_to_target: distanceValue })
                });
                const result = await response.json();
                if (result.success) {
                    showStatus(result.message || 'Distance to target updated', 'success');
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // ============================================
        // LONG-PRESS FUNCTIONALITY
        // ============================================
        function startLongPress(type, direction, min, max) {
            if (event) {
                event.preventDefault();
            }
            
            // Check if focus buttons are disabled (auto focus enabled)
            if (type === 'focus') {
                const decreaseBtn = document.getElementById('focus-decrease-btn');
                const increaseBtn = document.getElementById('focus-increase-btn');
                if (decreaseBtn.disabled || increaseBtn.disabled) {
                    return; // Don't allow long press when auto focus is enabled
                }
            }
            
            longPressType = type;
            longPressDirection = direction;
            longPressMin = min;
            longPressMax = max;
            
            let valueElement;
            if (type === 'zoom') {
                valueElement = document.getElementById('zoom-value');
            } else if (type === 'gain') {
                valueElement = document.getElementById('gain-value');
            } else if (type === 'focus') {
                valueElement = document.getElementById('focus-value');
            } else if (type === 'reg') {
                // For registration, we need to get the current mode and update the right value
            }
            
            if (valueElement) {
                longPressCurrentValue = parseInt(valueElement.textContent) || 0;
                longPressOriginalValue = longPressCurrentValue;
            } else if (type === 'reg') {
                const regMode = document.getElementById('reg-mode-shift').style.background === 'rgb(0, 123, 255)' ? 'shift' : 'stretch';
                if (direction === 'up' || direction === 'down') {
                    const yElement = regMode === 'shift' ? document.getElementById('reg-shift-y') : document.getElementById('reg-stretch-y');
                    longPressCurrentValue = parseInt(yElement.textContent.split(':')[1]) || 0;
                } else {
                    const xElement = regMode === 'shift' ? document.getElementById('reg-shift-x') : document.getElementById('reg-stretch-x');
                    longPressCurrentValue = parseInt(xElement.textContent.split(':')[1]) || 0;
                }
                longPressOriginalValue = longPressCurrentValue;
            }
            
            // Do single step immediately
            if (type === 'reg') {
                updateRegistrationLongPress();
            } else {
                updateValueLongPress();
            }
            
            // Start fast mode only after 2 seconds delay
            longPressTimeout = setTimeout(() => {
                longPressInterval = setInterval(() => {
                    if (type === 'reg') {
                        updateRegistrationLongPress();
                    } else {
                        updateValueLongPress();
                    }
                }, longPressSpeed);
            }, longPressDelay);
        }
        
        function updateValueLongPress() {
            if (longPressCurrentValue === null) return;
            
            let newValue = longPressCurrentValue + longPressDirection;
            
            if (longPressType === 'zoom') {
                if (newValue < 0) newValue = 0;
                if (newValue > 26) newValue = 26;
            } else if (longPressType === 'gain') {
                if (newValue < 0) newValue = 0;
                if (newValue > 255) newValue = 255;
            } else if (longPressType === 'focus') {
                if (newValue < 0) newValue = 0;
            } else {
                if (longPressMin !== null && newValue < longPressMin) newValue = longPressMin;
                if (longPressMax !== null && newValue > longPressMax) newValue = longPressMax;
            }
            
            if (newValue !== longPressCurrentValue) {
                longPressCurrentValue = newValue;
                
                let valueElement;
                if (longPressType === 'zoom') {
                    valueElement = document.getElementById('zoom-value');
                } else if (longPressType === 'gain') {
                    valueElement = document.getElementById('gain-value');
                } else if (longPressType === 'focus') {
                    valueElement = document.getElementById('focus-value');
                }
                
                if (valueElement) {
                    valueElement.textContent = newValue;
                }
            }
        }
        
        function updateRegistrationLongPress() {
            if (longPressCurrentValue === null) return;
            
            const regMode = document.getElementById('reg-mode-shift').style.background === 'rgb(0, 123, 255)' ? 'shift' : 'stretch';
            let newValue = longPressCurrentValue;
            
            if (longPressDirection === 'up') {
                newValue = longPressCurrentValue + 1;
            } else if (longPressDirection === 'down') {
                newValue = longPressCurrentValue - 1;
            } else if (longPressDirection === 'right') {
                newValue = longPressCurrentValue + 1;
            } else if (longPressDirection === 'left') {
                newValue = longPressCurrentValue - 1;
            }
            
            longPressCurrentValue = newValue;
            
            if (longPressDirection === 'up' || longPressDirection === 'down') {
                const yElement = regMode === 'shift' ? document.getElementById('reg-shift-y') : document.getElementById('reg-stretch-y');
                yElement.textContent = `Y:${newValue}`;
            } else {
                const xElement = regMode === 'shift' ? document.getElementById('reg-shift-x') : document.getElementById('reg-stretch-x');
                xElement.textContent = `X:${newValue}`;
            }
        }
        
        async function stopLongPress(type) {
            if (event) {
                event.preventDefault();
            }
            
            // Clear timeout (if fast mode hasn't started yet)
            if (longPressTimeout) {
                clearTimeout(longPressTimeout);
                longPressTimeout = null;
            }
            
            // Clear interval (if fast mode is running)
            if (longPressInterval) {
                clearInterval(longPressInterval);
                longPressInterval = null;
            }
            
            let finalValue = null;
            if (type === 'zoom') {
                finalValue = parseInt(document.getElementById('zoom-value').textContent) || 0;
                await sendZoomValue(finalValue);
            } else if (type === 'gain') {
                finalValue = parseInt(document.getElementById('gain-value').textContent) || 0;
                await sendGainValue(finalValue);
            } else if (type === 'focus') {
                finalValue = parseInt(document.getElementById('focus-value').textContent) || 0;
                await sendFocusValue(finalValue);
            } else if (type === 'reg') {
                const regMode = document.getElementById('reg-mode-shift').style.background === 'rgb(0, 123, 255)' ? 'shift' : 'stretch';
                if (longPressDirection === 'up' || longPressDirection === 'down') {
                    const yElement = regMode === 'shift' ? document.getElementById('reg-shift-y') : document.getElementById('reg-stretch-y');
                    finalValue = parseInt(yElement.textContent.split(':')[1]) || 0;
                } else {
                    const xElement = regMode === 'shift' ? document.getElementById('reg-shift-x') : document.getElementById('reg-stretch-x');
                    finalValue = parseInt(xElement.textContent.split(':')[1]) || 0;
                }
                await sendRegistrationValue(longPressDirection, finalValue);
            }
            
            longPressType = null;
            longPressDirection = null;
            longPressCurrentValue = null;
            longPressOriginalValue = null;
            longPressMin = null;
            longPressMax = null;
        }
        
        async function sendZoomValue(targetValue) {
            try {
                const response = await fetch('/set_zoom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ value: targetValue })
                });
                const result = await response.json();
                if (result.success) {
                    // Background listener will update the value when response arrives
                } else {
                    logToConsole(`Zoom error: ${result.error}`);
                }
            } catch (error) {
                logToConsole(`Zoom error: ${error.message}`);
            }
        }
        
        async function sendGainValue(targetValue) {
            try {
                const response = await fetch('/set_gain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ value: targetValue })
                });
                const result = await response.json();
                if (result.success) {
                    // Background listener will update the value when response arrives
                } else {
                    logToConsole(`Gain error: ${result.error}`);
                }
            } catch (error) {
                logToConsole(`Gain error: ${error.message}`);
            }
        }
        
        async function sendFocusValue(targetValue) {
            try {
                const response = await fetch('/set_focus', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ value: targetValue })
                });
                const result = await response.json();
                if (result.success) {
                    // Background listener will update the value when response arrives
                } else {
                    logToConsole(`Focus error: ${result.error}`);
                }
            } catch (error) {
                logToConsole(`Focus error: ${error.message}`);
            }
        }
        
        async function sendRegistrationValue(direction, targetValue) {
            try {
                const response = await fetch('/set_registration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        direction: direction,
                        value: targetValue 
                    })
                });
                const result = await response.json();
                if (result.success) {
                    updateRegistrationValues(result);
                } else {
                    logToConsole(`Registration error: ${result.error}`);
                }
            } catch (error) {
                logToConsole(`Registration error: ${error.message}`);
            }
        }
        
        // ============================================
        // REGISTRATION FUNCTIONS
        // ============================================
        function updateRegistrationValues(result) {
            if (result.offset_x !== undefined) {
                document.getElementById('reg-shift-x').textContent = `X:${result.offset_x}`;
            }
            if (result.offset_y !== undefined) {
                document.getElementById('reg-shift-y').textContent = `Y:${result.offset_y}`;
            }
            if (result.stretch_x !== undefined) {
                document.getElementById('reg-stretch-x').textContent = `X:${result.stretch_x}`;
            }
            if (result.stretch_y !== undefined) {
                document.getElementById('reg-stretch-y').textContent = `Y:${result.stretch_y}`;
            }
        }
        
        async function regOk() {
            const response = await fetch('/reg_ok', { method: 'POST' });
            const result = await response.json();
            logToConsole(result.message);
        }
        
        async function setRegistrationMode(mode) {
            try {
                const response = await fetch('/set_registration_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mode: mode })
                });
                const result = await response.json();
                if (result.success) {
                    if (mode === 'shift') {
                        document.getElementById('reg-mode-shift').style.background = '#007bff';
                        document.getElementById('reg-mode-stretch').style.background = '#6c757d';
                    } else {
                        document.getElementById('reg-mode-shift').style.background = '#6c757d';
                        document.getElementById('reg-mode-stretch').style.background = '#007bff';
                    }
                    logToConsole(`Registration mode: ${mode === 'shift' ? 'Shift' : 'Stretch/Compress'}`);
                }
            } catch (error) {
                logToConsole(`Error setting registration mode: ${error.message}`);
            }
        }
        
        async function setMasterRegistrationMode(mode) {
            try {
                const response = await fetch('/set_master_registration_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mode: mode })
                });
                const result = await response.json();
                if (result.success) {
                    // Update tab buttons
                    updateMasterRegistrationButtons(mode);
                    
                    // Update displayed values
                    document.getElementById('reg-shift-x').textContent = `X:${result.offset_x || 0}`;
                    document.getElementById('reg-shift-y').textContent = `Y:${result.offset_y || 0}`;
                    document.getElementById('reg-stretch-x').textContent = `X:${result.stretch_x || 0}`;
                    document.getElementById('reg-stretch-y').textContent = `Y:${result.stretch_y || 0}`;
                    
                    logToConsole(`Master registration mode: ${mode}`);
                }
            } catch (error) {
                logToConsole(`Error setting master registration mode: ${error.message}`);
            }
        }
        
        function updateMasterRegistrationButtons(mode) {
            // Reset all tab buttons
            document.getElementById('reg-master-per-zoom').classList.remove('active');
            document.getElementById('reg-master-per-zoom').style.background = '#6c757d';
            document.getElementById('reg-master-wide').classList.remove('active');
            document.getElementById('reg-master-wide').style.background = '#6c757d';
            document.getElementById('reg-master-narrow').classList.remove('active');
            document.getElementById('reg-master-narrow').style.background = '#6c757d';
            
            // Set active button
            if (mode === 'per_zoom') {
                document.getElementById('reg-master-per-zoom').classList.add('active');
                document.getElementById('reg-master-per-zoom').style.background = '#007bff';
            } else if (mode === 'wide') {
                document.getElementById('reg-master-wide').classList.add('active');
                document.getElementById('reg-master-wide').style.background = '#007bff';
            } else if (mode === 'narrow') {
                document.getElementById('reg-master-narrow').classList.add('active');
                document.getElementById('reg-master-narrow').style.background = '#007bff';
            }
        }
        
        async function smartRegistration() {
            const response = await fetch('/smart_registration', { method: 'POST' });
            const result = await response.json();
            logToConsole(result.message);
        }
        
        // ============================================
        // FOCUS FUNCTIONS
        // ============================================
        async function focusOk() {
            try {
                const response = await fetch('/focus_ok', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    logToConsole(result.message);
                    showStatus(result.message, 'success');
                }
            } catch (error) {
                logToConsole(`Focus OK error: ${error.message}`);
            }
        }
        
        async function toggleAutoFocus() {
            try {
                const autoFocusBtn = document.getElementById('auto-focus-btn');
                const currentState = autoFocusBtn.classList.contains('active');
                const newState = !currentState;
                
                const response = await fetch('/toggle_auto_focus', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ enable: newState })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update button state
                    if (result.auto_focus_enabled) {
                        autoFocusBtn.classList.add('active');
                        document.getElementById('auto-focus-status').textContent = 'ON';
                        // Disable focus adjustment buttons
                        document.getElementById('focus-decrease-btn').disabled = true;
                        document.getElementById('focus-increase-btn').disabled = true;
                    } else {
                        autoFocusBtn.classList.remove('active');
                        document.getElementById('auto-focus-status').textContent = 'OFF';
                        // Enable focus adjustment buttons
                        document.getElementById('focus-decrease-btn').disabled = false;
                        document.getElementById('focus-increase-btn').disabled = false;
                    }
                    showStatus(result.message, 'success');
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        function updateFocusButtonsState(autoFocusEnabled) {
            const decreaseBtn = document.getElementById('focus-decrease-btn');
            const increaseBtn = document.getElementById('focus-increase-btn');
            const autoFocusBtn = document.getElementById('auto-focus-btn');
            const autoFocusStatus = document.getElementById('auto-focus-status');
            
            if (autoFocusEnabled) {
                decreaseBtn.disabled = true;
                increaseBtn.disabled = true;
                autoFocusBtn.classList.add('active');
                autoFocusStatus.textContent = 'ON';
            } else {
                decreaseBtn.disabled = false;
                increaseBtn.disabled = false;
                autoFocusBtn.classList.remove('active');
                autoFocusStatus.textContent = 'OFF';
            }
        }
        
        async function smartFocus() {
            const response = await fetch('/smart_focus', { method: 'POST' });
            const result = await response.json();
            logToConsole(result.message);
        }
        
        // ============================================
        // GAIN FUNCTIONS
        // ============================================
        async function gainOk() {
            try {
                const response = await fetch('/gain_ok', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    logToConsole(result.message);
                    showStatus(result.message, 'success');
                }
            } catch (error) {
                logToConsole(`Gain OK error: ${error.message}`);
            }
        }
        
        async function setGainMin() {
            try {
                const response = await fetch('/set_gain_min', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showStatus(result.message, 'success');
                    logToConsole(result.message);
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                    logToConsole(`Error: ${result.error}`);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                logToConsole(`Error setting gain min: ${error.message}`);
            }
        }
        
        async function setGainMedium() {
            try {
                const response = await fetch('/set_gain_medium', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showStatus(result.message, 'success');
                    logToConsole(result.message);
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                    logToConsole(`Error: ${result.error}`);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                logToConsole(`Error setting gain medium: ${error.message}`);
            }
        }
        
        async function setGainMax() {
            try {
                const response = await fetch('/set_gain_max', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showStatus(result.message, 'success');
                    logToConsole(result.message);
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                    logToConsole(`Error: ${result.error}`);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                logToConsole(`Error setting gain max: ${error.message}`);
            }
        }
        
        async function clearGainValues() {
            try {
                const response = await fetch('/clear_gain_values', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showStatus(result.message, 'success');
                    logToConsole(result.message);
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                    logToConsole(`Error: ${result.error}`);
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                logToConsole(`Error clearing gain values: ${error.message}`);
            }
        }
        
        async function startGainCounting() {
            try {
                const response = await fetch('/start_gain_counting', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showStatus(result.message, 'success');
                    logToConsole(result.message);
                }
            } catch (error) {
                logToConsole(`Error starting gain counting: ${error.message}`);
            }
        }
        
        async function smartGain() {
            const response = await fetch('/smart_gain', { method: 'POST' });
            const result = await response.json();
            logToConsole(result.message);
        }
        
        async function setTimeInterval() {
            const timeInterval = document.getElementById('time-interval').value;
            try {
                const response = await fetch('/set_time_interval', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ time_interval: timeInterval })
                });
                const result = await response.json();
                if (result.success) {
                    logToConsole(`Time interval set to: ${result.time_interval}`);
                }
            } catch (error) {
                logToConsole(`Error setting time interval: ${error.message}`);
            }
        }
        
        // ============================================
        // TERMINAL COMMAND FUNCTIONS
        // ============================================
        function handleCommandKeyPress(event) {
            if (event.key === 'Enter') {
                sendTerminalCommand();
            }
        }
        
        async function sendTerminalCommand() {
            const terminalSelect = document.getElementById('terminal-select');
            const commandInput = document.getElementById('command-input');
            const terminal = terminalSelect.value;
            const command = commandInput.value.trim();
            
            if (!command) {
                showStatus('Please enter a command', 'error');
                return;
            }
            
            try {
                const response = await fetch('/send_terminal_command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        terminal: terminal,
                        command: command
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Clear input field
                    commandInput.value = '';
                    // Response will appear in console via background listener
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // ============================================
        // MOTOR MAX FUNCTIONS
        // ============================================
        async function calculateMotorMax() {
            try {
                showStatus('Calculating motor max...', 'info');
                const response = await fetch('/calculate_motor_max', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const result = await response.json();
                if (result.success) {
                    showStatus(result.message || 'Motor max calculated successfully', 'success');
                    // Update the motor max value display
                    document.getElementById('motor-max-value').textContent = result.motor_max || 0;
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // Update values on page load
        async function updateValues() {
            try {
                const [zoom, focus, gain, cps, regMode, motorMax, cameraSerial, technicianName, cameraMode, distanceToTarget] = await Promise.all([
                    fetch('/get_zoom').then(r => r.json()),
                    fetch('/get_focus').then(r => r.json()),
                    fetch('/get_gain').then(r => r.json()),
                    fetch('/get_cps').then(r => r.json()),
                    fetch('/get_registration_mode').then(r => r.json()),
                    fetch('/get_motor_max').then(r => r.json()),
                    fetch('/get_camera_serial').then(r => r.json()),
                    fetch('/get_technician_name').then(r => r.json()),
                    fetch('/get_camera_mode').then(r => r.json()),
                    fetch('/get_distance_to_target').then(r => r.json())
                ]);
                
                document.getElementById('zoom-value').textContent = zoom.zoom_value;
                document.getElementById('focus-value').textContent = focus.focus_value;
                document.getElementById('gain-value').textContent = gain.gain_value;
                document.getElementById('gain-min-value').textContent = gain.gain_min_value || 0;
                document.getElementById('gain-medium-value').textContent = gain.gain_medium_value || 0;
                document.getElementById('gain-max-value').textContent = gain.gain_max_value || 0;
                document.getElementById('cps-value').textContent = cps.cps_value;
                document.getElementById('motor-max-value').textContent = motorMax.motor_max || 0;
                
                // Only update input fields if they are not focused (user is not typing)
                const cameraSerialInput = document.getElementById('camera-serial');
                if (document.activeElement !== cameraSerialInput) {
                    cameraSerialInput.value = cameraSerial.camera_serial || '';
                }
                
                const technicianNameInput = document.getElementById('technician-name');
                if (document.activeElement !== technicianNameInput) {
                    technicianNameInput.value = technicianName.technician_name || '';
                }
                
                // Update distance to target
                const distanceToTargetInput = document.getElementById('distance-to-target');
                if (document.activeElement !== distanceToTargetInput) {
                    distanceToTargetInput.value = distanceToTarget.distance_to_target || 1;
                }
                
                // Update VIS and UV positions
                document.getElementById('vis-position-value').textContent = focus.vis_position || 0;
                document.getElementById('uv-position-value').textContent = focus.uv_position || 0;
                
                // Update Zoom Status and Distance
                document.getElementById('zoom-status-value').textContent = focus.zoom_status || '-';
                document.getElementById('distance-value').textContent = focus.distance || 0;
                
                // Update auto focus button state and focus buttons
                updateFocusButtonsState(focus.auto_focus_enabled || false);
                
                // Update registration values
                document.getElementById('reg-shift-x').textContent = `X:${regMode.offset_x || 0}`;
                document.getElementById('reg-shift-y').textContent = `Y:${regMode.offset_y || 0}`;
                document.getElementById('reg-stretch-x').textContent = `X:${regMode.stretch_x || 0}`;
                document.getElementById('reg-stretch-y').textContent = `Y:${regMode.stretch_y || 0}`;
                
                // Update registration mode buttons (Shift / Stretch-Compress)
                if (regMode.mode === 'shift') {
                    document.getElementById('reg-mode-shift').style.background = '#007bff';
                    document.getElementById('reg-mode-stretch').style.background = '#6c757d';
                } else {
                    document.getElementById('reg-mode-shift').style.background = '#6c757d';
                    document.getElementById('reg-mode-stretch').style.background = '#007bff';
                }
                
                // Update master registration mode buttons (Per Zoom / Wide / Narrow)
                updateMasterRegistrationButtons(regMode.master_mode || 'per_zoom');
                
                // Update camera mode buttons
                updateCameraModeButtons(cameraMode.camera_mode || 0);
            } catch (error) {
                console.error('Error updating values:', error);
            }
        }
        
        function updateCameraModeButtons(mode) {
            // Reset all buttons
            document.getElementById('camera-mode-vis').style.background = '#6c757d';
            document.getElementById('camera-mode-uv').style.background = '#6c757d';
            document.getElementById('camera-mode-combined').style.background = '#6c757d';
            
            // Set active button based on mode: 1=VIS, 2=UV, 3=UV&VIS
            if (mode === 1) {
                document.getElementById('camera-mode-vis').style.background = '#007bff';
            } else if (mode === 2) {
                document.getElementById('camera-mode-uv').style.background = '#007bff';
            } else if (mode === 3) {
                document.getElementById('camera-mode-combined').style.background = '#007bff';
            }
        }
        
        async function setCameraMode(mode) {
            try {
                const response = await fetch('/set_camera_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mode: mode })
                });
                const result = await response.json();
                if (result.success) {
                    // Update buttons immediately
                    updateCameraModeButtons(mode);
                } else {
                    console.error('Failed to set camera mode:', result.error);
                }
            } catch (error) {
                console.error('Error setting camera mode:', error);
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            updateValues();
            updateConsole();
        });
        
        // Update values periodically
        updateInterval = setInterval(updateValues, 2000);
        
        // Update console periodically
        consoleInterval = setInterval(updateConsole, 500);
    </script>
</body>
</html>
